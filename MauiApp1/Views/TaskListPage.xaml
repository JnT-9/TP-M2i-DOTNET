<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MauiApp1.ViewModels"
             xmlns:models="clr-namespace:MauiApp1.Models"
             x:Class="MauiApp1.Views.TaskListPage"
             x:DataType="viewmodels:TaskListViewModel"
             BackgroundColor="#f5f5f5"
             Title="Task Manager">

    <Grid RowDefinitions="Auto,*,Auto" Padding="16">
        <!-- En-tête avec filtre -->
        <Frame Grid.Row="0" 
               Margin="0,0,0,16" 
               Padding="16" 
               CornerRadius="10" 
               BorderColor="Transparent"
               BackgroundColor="White"
               HasShadow="True">
            <VerticalStackLayout Spacing="10">
                <Label Text="Filter by status:" 
                       FontSize="16"
                       TextColor="#333333" />
                <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                    <Button Text="All" 
                            Command="{Binding FilterByStatusCommand}" 
                            CommandParameter=""
                            BackgroundColor="{Binding SelectedStatus, Converter={StaticResource SelectedFilterButtonColorConverter}, ConverterParameter=''}"
                            TextColor="White"
                            FontSize="12"
                            HeightRequest="40"
                            WidthRequest="80"
                            CornerRadius="20" />
                    <Button Text="Todo" 
                            Command="{Binding FilterByStatusCommand}" 
                            CommandParameter="{x:Static models:TaskConstants+Status.Todo}"
                            BackgroundColor="{Binding SelectedStatus, Converter={StaticResource SelectedFilterButtonColorConverter}, ConverterParameter=Todo}"
                            TextColor="White"
                            FontSize="12"
                            HeightRequest="40"
                            WidthRequest="80"
                            CornerRadius="20" />
                    <Button Text="In Progress" 
                            Command="{Binding FilterByStatusCommand}" 
                            CommandParameter="{x:Static models:TaskConstants+Status.InProgress}"
                            BackgroundColor="{Binding SelectedStatus, Converter={StaticResource SelectedFilterButtonColorConverter}, ConverterParameter=InProgress}"
                            TextColor="White"
                            FontSize="12"
                            HeightRequest="40"
                            WidthRequest="100"
                            CornerRadius="20" />
                    <Button Text="Done" 
                            Command="{Binding FilterByStatusCommand}" 
                            CommandParameter="{x:Static models:TaskConstants+Status.Done}"
                            BackgroundColor="{Binding SelectedStatus, Converter={StaticResource SelectedFilterButtonColorConverter}, ConverterParameter=Done}"
                            TextColor="White"
                            FontSize="12"
                            HeightRequest="40"
                            WidthRequest="80"
                            CornerRadius="20" />
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </Frame>

        <!-- Liste des tâches -->
        <RefreshView Grid.Row="1" 
                     IsRefreshing="{Binding IsRefreshing}" 
                     Command="{Binding LoadTasksCommand}">
            <CollectionView ItemsSource="{Binding Tasks}"
                            EmptyView="No tasks found. Pull to refresh or add a new task."
                            Margin="0,0,0,16">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:TaskItem">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Delete" 
                                               BackgroundColor="#ff5252"
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TaskListViewModel}}, Path=DeleteTaskCommand}"
                                               CommandParameter="{Binding}" />
                                </SwipeItems>
                            </SwipeView.RightItems>
                            
                            <Frame Margin="0,6" 
                                   Padding="16" 
                                   CornerRadius="10" 
                                   BorderColor="Transparent"
                                   BackgroundColor="White"
                                   HasShadow="True">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TaskListViewModel}}, Path=ViewTaskDetailsCommand}"
                                        CommandParameter="{Binding}" />
                                </Frame.GestureRecognizers>
                                
                                <Grid ColumnDefinitions="*,Auto" RowSpacing="10">
                                    <VerticalStackLayout Grid.Column="0" Spacing="8">
                                        <Label Text="{Binding Title}" 
                                               FontAttributes="Bold"
                                               FontSize="18"
                                               TextColor="#333333" />
                                        <Grid ColumnDefinitions="Auto,Auto,*" ColumnSpacing="12">
                                            <!-- Priority Badge -->
                                            <Border Grid.Column="0"
                                                    StrokeShape="RoundRectangle 12"
                                                    BackgroundColor="{Binding Priority, Converter={StaticResource PriorityColorConverter}}"
                                                    Padding="8,4">
                                                <Label Text="{Binding Priority}" 
                                                       TextColor="White" 
                                                       FontSize="12"
                                                       FontAttributes="Bold" />
                                            </Border>
                                            
                                            <!-- Status Badge -->
                                            <Border Grid.Column="1"
                                                    StrokeShape="RoundRectangle 12"
                                                    BackgroundColor="{Binding Status, Converter={StaticResource StatusColorConverter}}"
                                                    Padding="8,4">
                                                <Label Text="{Binding Status}" 
                                                       TextColor="White" 
                                                       FontSize="12"
                                                       FontAttributes="Bold" />
                                            </Border>
                                            
                                            <!-- Due Date -->
                                            <Label Grid.Column="2"
                                                   Text="{Binding DueDate, StringFormat='Due: {0:dd/MM/yyyy}'}"
                                                   IsVisible="{Binding DueDate, Converter={StaticResource NullToBoolConverter}}"
                                                   TextColor="#666666"
                                                   FontSize="12"
                                                   HorizontalOptions="End"
                                                   VerticalOptions="Center" />
                                        </Grid>
                                    </VerticalStackLayout>
                                    
                                    <!-- Change Status Button -->
                                    <Button Grid.Column="1" 
                                            Text="Next Status"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TaskListViewModel}}, Path=UpdateTaskStatusCommand}"
                                            CommandParameter="{Binding}"
                                            BackgroundColor="#4CAF50"
                                            TextColor="White"
                                            FontSize="12"
                                            HeightRequest="40"
                                            WidthRequest="100"
                                            Padding="5"
                                            CornerRadius="20"
                                            VerticalOptions="Center" />
                                </Grid>
                            </Frame>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Bouton d'ajout de tâche -->
        <Button Grid.Row="2" 
                Text="Add New Task" 
                Command="{Binding AddNewTaskCommand}"
                BackgroundColor="#2196F3"
                TextColor="White"
                FontAttributes="Bold"
                HeightRequest="50"
                CornerRadius="25"
                HorizontalOptions="Fill"
                Margin="20,0" />
    </Grid>
</ContentPage> 